#!/usr/bin/env bash
# an adaption of https://github.com/seanbreckenridge/calories-scripts
# to work on my own calories system
#
# prompts me with fzf to pick something from my 'food'
# pass the '-d' flag to prompt for datetime using autotui
#
# pass the -p flag to prompt in the background
#
# this works both in the terminal and when called as an
# 'application' from rofi/keybinding, assuming
# you have the following on your $PATH:
#
# https://sean.fish/d/cross-platform/attached-to-terminal
# https://sean.fish/d/cross-platform/print-or-notify
# https://sean.fish/d/cross-platform/notify
# https://sean.fish/d/picker
#
# otherwise falls back to default terminal behaviour
# if being run from the terminal

declare GUI_PROMPT='0'
readonly script_name='cz'

havecmd() {
	local BINARY ERRMSG
	# error if first argument isn't provided
	BINARY="${1:?Must provide command to check}"
	# the commend exists, exit with 0 (success!)
	if command -v "${BINARY}" >/dev/null 2>&1; then
		return 0
	else
		# construct error message
		ERRMSG="'${script_name}' requires '${BINARY}', could not find that on your \$PATH"
		if [[ -n "$2" ]]; then
			ERRMSG="${ERRMSG}. $2"
		fi
		printf '%s\n' "${ERRMSG}" 1>&2
		return 1
	fi
}

set -e
havecmd jq
havecmd awk
havecmd chomp 'Install from https://github.com/seanbreckenridge/chomp'
havecmd print-or-notify 'Uses my cross platform scripts here https://github.com/seanbreckenridge/dotfiles/tree/master/.local/scripts/cross-platform. Could remove the print-or-notify calls here to just be "echo" instead'
set +e

with_date() {
	local JSON_DATA
	JSON_DATA="$(jq -n \
		--arg TIMESTAMP "$(date '+%s')" \
		--arg CALORIES "$1" \
		--arg FOODNAME "$2" \
		'[{"when":$TIMESTAMP | tonumber, "food": $FOODNAME, "calories": $CALORIES | tonumber}]')" || return $?
	python3 -m ttally from-json food <<<"${JSON_DATA}"
}

without_date() {
	local JSON_DATA TEMPFILE
	JSON_DATA="$(jq -n \
		--arg CALORIES "$1" \
		--arg FOODNAME "$2" \
		'[{"food": $FOODNAME, "calories": $CALORIES | tonumber}]')" || return $?
	TEMPFILE="$(mktemp)"
	printf '%s' "${JSON_DATA}" >"${TEMPFILE}"
	python3 -m ttally from-json --partial food --file "${TEMPFILE}" || return $?
	rm "${TEMPFILE}"
}

# pick using fzf if on a terminal, or https://sean.fish/d/picker if run with a keybinding
pick() {
	local PROMPT_MSG
	PROMPT_MSG='What to add to calories?'
	if hash picker 2>/dev/null; then
		if ((GUI_PROMPT)); then
			picker -p "${PROMPT_MSG}  " || return $?
			return
		fi
	fi
	fzf -q "$*" --header="${PROMPT_MSG}" || return $?
}

main() {
	local SELECTED USE_NOW
	local -a CHOSEN

	# prompt for datetime instead
	USE_NOW='1'
	while getopts "pdh" opt; do
		case "${opt}" in
		p)
			GUI_PROMPT='1'
			;;
		d)
			USE_NOW='0'
			;;
		h)
			printf 'Usage: cz [-h] [-p] [-d]\n'
			printf 'prompts me with fzf to pick something from my food to add again\n'
			printf '\t-h\tShow help message\n'
			printf '\t-d\tPrompt for the datetime\n'
			printf '\t-p\tPrompt using my GUI scripts\n'
			exit 0
			;;
		*)
			printf 'Unknown argument: %s\n' "${opt}"
			exit 1
			;;
		esac
	done

	shift "$((OPTIND - 1))"

	# pick an item using fzf/rofi/choose-gui
	SELECTED="$(python3 -m ttally export food --stream | jq -r '"\(.calories)|\(.food)"' | sort | uniq -c | sort -n | chomp | cut -d' ' -f2- | tac | pick "$@")" || {
		print-or-notify "Didn't select anything to add to calories..." 1>&2
		return 1
	}

	# split into array
	readarray -d "|" -t CHOSEN <<<"${SELECTED}"
	if [[ "${#CHOSEN[@]}" != 2 ]]; then
		print-or-notify "Error splitting '${SELECTED}' into two elements, food description can't contain the pipe '|' character" 1>&2
		return 1
	fi

	# add item to food
	local CALS FOODNAME
	CALS="${CHOSEN[0]}"
	FOODNAME="${CHOSEN[1]/$'\n'/}"
	if ((USE_NOW == 0)); then
		without_date "${CALS}" "${FOODNAME}" || return $?
	else
		with_date "${CALS}" "${FOODNAME}" || return $?
	fi

	# print recent items so I can review
	print-or-notify "$(python3 -m ttally recent food)"
}

main "$@" || exit $?
